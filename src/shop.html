<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>TCDining</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 0;
			padding: 20px;
			background: #f9f9f9;
		}

		h1 {
			text-align: center;
		}

		.items {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 20px;
			margin: 20px 0;
		}

		.item {
			background: white;
			padding: 15px;
			border-radius: 8px;
			box-shadow: 0 2px 6px rgba(0,0,0,0.1);
			text-align: center;
		}

			.item img {
				max-width: 100%;
				border-radius: 5px;
			}

			.item button {
				margin-top: 10px;
				background: #28a745;
				color: white;
				border: none;
				padding: 8px 12px;
				border-radius: 5px;
				cursor: pointer;
			}

				.item button:hover {
					background: #1e7e34;
				}
		/* Modal styles */
		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			overflow: auto;
			background-color: rgba(0,0,0,0.5);
		}

		.modal-content {
			background: white;
			margin: 10% auto;
			padding: 30px;
			border-radius: 8px;
			max-width: 400px;
			position: relative;
		}

		.close-btn {
			position: absolute;
			right: 15px;
			top: 10px;
			font-size: 24px;
			font-weight: bold;
			cursor: pointer;
		}

		label {
			display: block;
			margin-top: 10px;
		}

		select, input[type=number], textarea {
			width: 100%;
			padding: 8px;
			margin-top: 4px;
			border-radius: 5px;
			border: 1px solid #ccc;
		}

		button.submit-item {
			margin-top: 15px;
			background: #007BFF;
			color: white;
			border: none;
			padding: 10px 15px;
			border-radius: 5px;
			cursor: pointer;
			width: 100%;
		}

			button.submit-item:hover {
				background: #0056b3;
			}
		/* Cart styles */
		#cart {
			max-width: 600px;
			margin: 30px auto;
			background: white;
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 2px 6px rgba(0,0,0,0.1);
		}

			#cart h2 {
				margin-top: 0;
			}

		#cart-items {
			list-style: none;
			padding-left: 0;
		}

			#cart-items li {
				border-bottom: 1px solid #ddd;
				padding: 10px 0;
			}

		#checkout-btn {
			margin-top: 15px;
			background: #28a745;
			color: white;
			border: none;
			padding: 12px 20px;
			border-radius: 5px;
			cursor: pointer;
			width: 100%;
		}

			#checkout-btn:hover {
				background: #1e7e34;
			}
		/* Checkout form */
		#checkout-form {
			display: none;
			max-width: 600px;
			margin: 30px auto;
			background: white;
			padding: 30px;
			border-radius: 8px;
			box-shadow: 0 2px 6px rgba(0,0,0,0.1);
		}

			#checkout-form label {
				margin-top: 10px;
			}

			#checkout-form input, #checkout-form textarea {
				width: 100%;
				padding: 8px;
				margin-top: 4px;
				border-radius: 5px;
				border: 1px solid #ccc;
			}

			#checkout-form button[type="submit"] {
				margin-top: 15px;
				background: #007BFF;
				color: white;
				border: none;
				padding: 12px 20px;
				border-radius: 5px;
				cursor: pointer;
				width: 100%;
			}

				#checkout-form button[type="submit"]:hover {
					background: #0056b3;
				}

		#result {
			max-width: 600px;
			margin: 30px auto;
			text-align: center;
			font-weight: bold;
		}

		.text-green-500 {
			color: green;
		}

		.text-red-500 {
			color: red;
		}


		.scrolling-images {
			width: 100%;
			overflow: hidden;
			background: #fff;
			border-radius: 8px;
			box-shadow: 0 2px 6px rgba(0,0,0,0.08);
			margin: 0 auto 24px auto;
			max-width: 900px;
		}

		.scrolling-track {
			display: flex;
			width: max-content;
			animation: scrollImages 20s linear infinite;
		}

		.scrolling-images img {
			height: 300px;
			margin: 0 12px;
			border-radius: 6px;
			box-shadow: 0 1px 4px rgba(0,0,0,0.07);
		}

		@keyframes scrollImages {
			0% {
				transform: translateX(0);
			}

			100% {
				transform: translateX(-50%);
			}
		}

	</style>
</head>



<body>
	<h1>TCDining</h1>
	<!-- Scrolling Images Carousel -->
	<div class="scrolling-images">
		<div class="scrolling-track">
			<img src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=400&q=80" alt="Food 1">
			<img src="https://static01.nyt.com/images/2024/01/10/multimedia/AS-Burrito-vzhk/AS-Burrito-vzhk-mediumSquareAt3X.jpg" alt="Food 2">
			<img src="https://www.marthastewart.com/thmb/uSaztTRX13520w0w-inW35pDZ0s=/1500x0/filters:no_upscale():max_bytes(150000):strip_icc()/MS-312932-bean-burritos-hero-7421-0096cb35178e4650b4b65012e0e7b699.jpg" alt="Food 3">
			<img src="https://www.allrecipes.com/thmb/w2WekH0XGb0pxsj0qAXwvFdSwR0=/1500x0/filters:no_upscale():max_bytes(150000):strip_icc()/14041-delicious-black-bean-burritos-ddmfs-3x2-008-7fbf871b145f4f35a45650ee903fce73.jpg" alt="Food 4">
			<!--Repeat images for seamless loop-->
			<img src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=400&q=80" alt="Food 1">
			<img src="https://static01.nyt.com/images/2024/01/10/multimedia/AS-Burrito-vzhk/AS-Burrito-vzhk-mediumSquareAt3X.jpg" alt="Food 2">
		</div>
	</div>
	<div class="items" id="items-container">
		<!-- Items will be loaded here -->
	</div>
	<!-- Add this below your main items container -->
	<h2 id="desserts-header" style="text-align:center; margin-top:40px;">Desserts & Extras</h2>
	<div class="items" id="desserts-container">
		<!-- Desserts and extras will be loaded here -->
	</div>

	<!-- Modal for item request -->
	<div id="itemModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modalTitle" aria-modal="true">
		<div class="modal-content">
			<span class="close-btn" aria-label="Close modal">&times;</span>
			<h2 id="modalTitle">Request Item</h2>
			<form id="itemForm">
				<div>
					<strong id="modalItemName"></strong> - $<span id="modalItemPrice"></span>
				</div>
				<label for="quantity">Quantity</label>
				<input type="number" id="quantity" name="quantity" min="1" value="1" required />
				<label for="prep">Preparation</label>
				<select id="prep" name="prep" required>
					<!-- options populated dynamically -->
				</select>
				<label for="drink">Drink</label>
				<select id="drink" name="drink" required>
					<!-- options populated dynamically -->
				</select>
				<label for="specialMessage">Special Message (optional)</label>
				<textarea id="specialMessage" name="specialMessage" rows="3" placeholder="Any special instructions for this item?"></textarea>
				<button type="submit" class="submit-item">Add to Cart</button>
			</form>
		</div>
	</div>

	<!-- Cart summary -->
	<div id="cart" aria-live="polite" aria-atomic="true" aria-relevant="additions removals">
		<h2>Your Cart</h2>
		<ul id="cart-items">
			<li>Your cart is empty.</li>
		</ul>
		<button id="checkout-btn" disabled>Checkout</button>
	</div>

	<!-- Checkout form -->
	<form id="checkout-form" style="display:none;" novalidate>
		<h2>Checkout</h2>
		<label for="customerName">Your Name</label>
		<input type="text" id="customerName" name="name" required />
		<label for="customerNumber">Your Number</label>
		<input type="text" id="customerNumber" name="number" required pattern="\(\d{3}\) \d{3}-\d{4}" maxlength="14" inputmode="numeric" placeholder="(123) 456-7890" />
		<label for="orderMessage">Additional Message (optional)</label>
		<textarea id="orderMessage" name="message" rows="4" placeholder="Any additional instructions for your order?"></textarea>
		<button type="submit">Send Order</button>
	</form>

	<div id="result"></div>
	<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
	<script>
		// Fetch and render items from Google Sheets CSV
		async function fetchAndRenderItems() {
			const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRYo7as43prQyDOMRfUPWkUsTlINw6BWqlkDYpvdwlKaQZg6mEk_iBygLF99swd8QuP3uAKtlVqNv6g/pub?output=csv';
			const container = document.getElementById('items-container');
			const dessertsContainer = document.getElementById('desserts-container'); // <-- Add this line
			console.log('[DEBUG] Fetching CSV from:', csvUrl);
			const response = await fetch(csvUrl);
			const text = await response.text();
			console.log('[DEBUG] Raw CSV text:', text.substring(0, 200) + '...');

			// Use PapaParse to parse CSV
			const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
			console.log('[DEBUG] Parsed CSV:', parsed);

			const items = parsed.data;
			console.log('[DEBUG] Items array:', items);

			container.innerHTML = '';
			dessertsContainer.innerHTML = ''; // Clear previous

			items.forEach(item => {
				console.log('[DEBUG] Rendering item:', item);
				const prepOptions = item['Prep Options'] ? item['Prep Options'].split(',').map(s => s.trim()).join(',') : '';
				const drinks = item['Drinks'] ? item['Drinks'].split(',').map(s => s.trim()).join(',') : '';
				const html = `
			<div class="item"
				data-name="${item['Name']}"
				data-price="${item['Price']}"
				data-prep-options="${prepOptions}"
				data-drinks="${drinks}">
				<h3>${item['Name']}</h3>
				<p style="color:#28a745; margin-bottom:8px;">$${item['Price']}</p>
				<ul style="text-align:left; margin:0 auto 10px auto; max-width:250px; padding-left:20px;">
					${item['Description'] ? item['Description'].split(',').map(line => `<li>${line.trim()}</li>`).join('') : ''}
				</ul>
				<button class="request-btn">Request</button>
			</div>
		`;
				const category = (item['Category'] || '').toLowerCase();
				if (category.includes('dessert') || category.includes('extra') || category.includes('tart')) {
					dessertsContainer.insertAdjacentHTML('beforeend', html);
				} else {
					container.insertAdjacentHTML('beforeend', html);
				}
			});
			// At the end of fetchAndRenderItems()
			const dessertsHeader = document.getElementById('desserts-header');
			if (dessertsContainer.children.length === 0) {
				dessertsHeader.style.display = 'none';
			} else {
				dessertsHeader.style.display = '';
			}

			// Re-attach event listeners for new buttons
			document.querySelectorAll('.request-btn').forEach(button => {
				button.addEventListener('click', e => {
					const itemDiv = e.target.closest('.item');
					console.log('[DEBUG] Request button clicked for:', itemDiv.dataset.name);
					currentItem = {
						name: itemDiv.dataset.name,
						price: parseFloat(itemDiv.dataset.price),
						prepOptions: itemDiv.dataset.prepOptions ? itemDiv.dataset.prepOptions.split(',') : [],
						drinks: itemDiv.dataset.drinks ? itemDiv.dataset.drinks.split(',') : []
					};
					openModal(currentItem);
				});
			});
			console.log('[DEBUG] Event listeners attached to request buttons');
		}

		// Main shop logic
		(() => {
			const modal = document.getElementById('itemModal');
			const modalTitle = document.getElementById('modalItemName');
			const modalPrice = document.getElementById('modalItemPrice');
			const prepSelect = document.getElementById('prep');
			const drinkSelect = document.getElementById('drink');
			const quantityInput = document.getElementById('quantity');
			const specialMessageInput = document.getElementById('specialMessage');
			const itemForm = document.getElementById('itemForm');
			const closeBtn = modal.querySelector('.close-btn');
			const cartItemsList = document.getElementById('cart-items');
			const checkoutBtn = document.getElementById('checkout-btn');
			const checkoutForm = document.getElementById('checkout-form');
			const resultDiv = document.getElementById('result');
			const customerNumberInput = document.getElementById('customerNumber');

			window.currentItem = null; // Make accessible for fetchAndRenderItems
			let cart = [];

			// Format phone number input on checkout form
			customerNumberInput.addEventListener('input', e => {
				let value = e.target.value.replace(/\D/g, '').slice(0, 10);
				let formatted = '';
				if (value.length > 0) {
					formatted = '(' + value.slice(0, 3);
				}
				if (value.length >= 4) {
					formatted += ') ' + value.slice(3, 6);
				}
				if (value.length >= 7) {
					formatted += '-' + value.slice(6, 10);
				}
				e.target.value = formatted;
			});

			// Open modal when clicking request button (initially, but replaced by fetchAndRenderItems)
			document.querySelectorAll('.request-btn').forEach(button => {
				button.addEventListener('click', e => {
					const itemDiv = e.target.closest('.item');
					console.log('[DEBUG] (Initial) Request button clicked for:', itemDiv.dataset.name);
					currentItem = {
						name: itemDiv.dataset.name,
						price: parseFloat(itemDiv.dataset.price),
						prepOptions: itemDiv.dataset.prepOptions.split(','),
						drinks: itemDiv.dataset.drinks.split(',')
					};
					openModal(currentItem);
				});
			});

			window.openModal = function (item) {
				console.log('[DEBUG] Opening modal for item:', item);
				modalTitle.textContent = item.name;
				modalPrice.textContent = item.price.toFixed(2);

				// Handle prep options
				const prepLabel = prepSelect.previousElementSibling; // The <label> for prep
				if (item.prepOptions.length === 0 || (item.prepOptions.length === 1 && item.prepOptions[0] === "")) {
					prepLabel.style.display = 'none';
					prepSelect.style.display = 'none';
					prepSelect.required = false;
					prepSelect.innerHTML = '';
				} else {
					prepLabel.style.display = '';
					prepSelect.style.display = '';
					prepSelect.required = true;
					prepSelect.innerHTML = '';
					item.prepOptions.forEach(opt => {
						if (opt) {
							const option = document.createElement('option');
							option.value = opt;
							option.textContent = opt;
							prepSelect.appendChild(option);
						}
					});
				}

				// Populate drink options
				drinkSelect.innerHTML = '';
				item.drinks.forEach(drink => {
					if (drink) {
						const option = document.createElement('option');
						option.value = drink;
						option.textContent = drink;
						drinkSelect.appendChild(option);
					}
				});

				quantityInput.value = 1;
				specialMessageInput.value = '';

				modal.style.display = 'block';
				modal.setAttribute('aria-hidden', 'false');
				quantityInput.focus();
			};

			// Close modal
			closeBtn.addEventListener('click', () => {
				console.log('[DEBUG] Modal close button clicked');
				closeModal();
			});
			window.addEventListener('click', e => {
				if (e.target === modal) {
					console.log('[DEBUG] Modal background clicked');
					closeModal();
				}
			});
			window.addEventListener('keydown', e => {
				if (e.key === 'Escape' && modal.style.display === 'block') {
					console.log('[DEBUG] Escape key pressed, closing modal');
					closeModal();
				}
			});

			function closeModal() {
				console.log('[DEBUG] Closing modal');
				modal.style.display = 'none';
				modal.setAttribute('aria-hidden', 'true');
				currentItem = null;
			}

			// Add item to cart on form submit
			itemForm.addEventListener('submit', e => {
				e.preventDefault();
				if (!itemForm.checkValidity()) {
					itemForm.reportValidity();
					return;
				}
				const quantity = parseInt(quantityInput.value, 10);
				const prep = prepSelect.value;
				const drink = drinkSelect.value;
				const specialMessage = specialMessageInput.value.trim();

				console.log('[DEBUG] Adding to cart:', {
					name: currentItem.name,
					price: currentItem.price,
					quantity,
					prep,
					drink,
					specialMessage
				});

				// Add to cart array
				cart.push({
					name: currentItem.name,
					price: currentItem.price,
					quantity,
					prep,
					drink,
					specialMessage
				});

				updateCartUI();
				closeModal();
			});

			function updateCartUI() {
				console.log('[DEBUG] Updating cart UI. Cart:', cart);
				if (cart.length === 0) {
					cartItemsList.innerHTML = '<li>Your cart is empty.</li>';
					checkoutBtn.disabled = true;
				} else {
					cartItemsList.innerHTML = '';
					cart.forEach((item, index) => {
						const li = document.createElement('li');
						li.innerHTML = `<strong>${item.name}</strong> x${item.quantity} - $${(item.price * item.quantity).toFixed(2)}<br>
									Prep: ${item.prep}, Drink: ${item.drink}${item.specialMessage ? `<br>Note: ${item.specialMessage}` : ''}
									<br><button aria-label="Remove ${item.name} from cart" data-index="${index}" class="remove-btn" style="margin-top:5px; background:#dc3545; color:#fff; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">Remove</button>`;
						cartItemsList.appendChild(li);
					});
					checkoutBtn.disabled = false;
				}
			}

			// Remove item from cart
			cartItemsList.addEventListener('click', e => {
				if (e.target.classList.contains('remove-btn')) {
					const idx = parseInt(e.target.dataset.index, 10);
					console.log('[DEBUG] Removing item at index:', idx);
					if (!isNaN(idx)) {
						cart.splice(idx, 1);
						updateCartUI();
					}
				}
			});

			// Show checkout form on checkout button click
			checkoutBtn.addEventListener('click', () => {
				console.log('[DEBUG] Checkout button clicked');
				checkoutForm.style.display = 'block';
				checkoutBtn.disabled = true;
				window.scrollTo({ top: checkoutForm.offsetTop, behavior: 'smooth' });
			});

			// Handle checkout form submission
			checkoutForm.addEventListener('submit', e => {
				e.preventDefault();
				if (!checkoutForm.checkValidity()) {
					checkoutForm.reportValidity();
					return;
				}
				if (cart.length === 0) {
					alert('Your cart is empty.');
					return;
				}

				const formData = new FormData(checkoutForm);
				formData.append('access_key', '990bc17d-553b-4fa3-8bad-5a7bb35a164e');
				formData.append('subject', 'New Order from TCDining Shop');

				// Add cart items details
				const itemsDescription = cart.map(item => {
					return `${item.name} x${item.quantity} (Prep: ${item.prep}, Drink: ${item.drink}${item.specialMessage ? `, Note: ${item.specialMessage}` : ''})`;
				}).join('; ');
				formData.append('items', itemsDescription);

				// Add timestamp
				const now = new Date();
				const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
				const dateStr = now.toLocaleDateString(undefined, options);
				const timeStr = now.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
				formData.append('timestamp', `${dateStr} ${timeStr}`);

				console.log('[DEBUG] Submitting order:', Object.fromEntries(formData.entries()));

				resultDiv.textContent = 'Sending your order...';
				resultDiv.className = '';
				fetch('https://api.web3forms.com/submit', {
					method: 'POST',
					body: formData
				})
					.then(async response => {
						const json = await response.json();
						console.log('[DEBUG] Order submission response:', json);
						if (response.ok) {
							resultDiv.textContent = json.message || 'Order sent successfully!';
							resultDiv.className = 'text-green-500';
							// Clear cart and form
							cart = [];
							updateCartUI();
							checkoutForm.reset();
							checkoutForm.style.display = 'none';
							checkoutBtn.disabled = false;
						} else {
							resultDiv.textContent = json.message || 'Failed to send order.';
							resultDiv.className = 'text-red-500';
							checkoutBtn.disabled = false
						}
					})
					.catch((err) => {
						console.error('[DEBUG] Order submission error:', err);
						resultDiv.textContent = 'Something went wrong while sending your order.';
						resultDiv.className = 'text-red-500';
						checkoutBtn.disabled = false;
					});
			});
		})();

		// Load items on page load
		fetchAndRenderItems();
	</script>
</body>
</html>
